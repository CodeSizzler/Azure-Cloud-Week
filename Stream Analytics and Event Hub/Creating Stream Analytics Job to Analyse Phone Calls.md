<h1>Creating Stream Analytics Job to Analyse Phone Calls </h1>

<h2>Use case scenario</h2>
<p>Contoso wants to use Azure Stream Analytics to analyse a sample phone call that is generated by a client application. The phone call data generated by the client application contains some fraudulent calls, Here as a Data Analyst define a Stream Analytics job to filter such calls.  </p>

<h2>Solution Architecture</h2>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/1.PNG"/>

<h2>Prerequisites</h2>
<p> Before beginning this demo, make sure to download an application from this link for generating phone call event.</p>
<p>http://download.microsoft.com/download/8/B/D/8BD50991-8D54-4F59-AB833354B69C8A7E/TelcoGenerator.zip </p>

<h2>Steps:</h2>
<h2>Creating Event Hub</h2>
<p>1. This demo is about creating event hub service in azure portal. To create the service, go to + Create a resource -> Internet of Things -> Event Hubs. Then give it a name, choose a required pricing tier, a resource group and click on create.</p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/2.PNG"/>
<p>2. Once the event hub gets created, in its overview page, click on + Event Hub to create event hub.</p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/3.PNG"/>
<p>3. Give a name to the hub and click on Create. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/4.PNG"/>
<p>4. After 	completing 	this, 	go 	to 	the 	Shared 	Access 	Policies -> RootManagerSharedAccessKey and copy the connection string and maintain it in notepad for later.</p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/5.PNG"/>

<h2>Generating Phone Call Data</h2>
<p>1. Extract the downloaded solution file in the beginning and open telcodatagen.exe.config file in notepad. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/6.png"/>
<p>2. In the file that you opened, for EventHubName give the name of your event hub. Same way in the next line replace the ConnectionString with your connection string of your EventHub. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/7.PNG"/>
<p>3. Now, open the command prompt and navigate to the folder in which you have solution files. After that execute the command  </p>
  <p>telcodatagen.exe 1000 .2 2 </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/8.PNG"/>

<h2>Creating Stream Analytics Job</h2>
<p>Go to + Create a resource -> Analytics -> Stream Analytics job. Give the job a name, choose a resource group, a location and click on Create button. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/9.PNG"/>

<h2>Adding Inputs to Job</h2>
<p>1. Once after the stream analytics job gets created, go to the Inputs and click on + Add stream input and choose Event Hub. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/10.PNG"/>
<p>2. Now, give Input alias as CallStream and chose azure subscription. In the place of EventHub Namespace choose the EventHub that you created to receive phone call data. Choose the resource group and policy. At last click on Save. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/11.PNG"/>

<h2>Adding Output</h2>
<p>1. Again, in the left side menu, click on Outputs and click on + Add and choose Power BI.  </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/12.PNG"/>
<p>2. Next, name it as MyPBIoutput and choose group workspace as shown below. For Dataset Name give value as ASAdataset and table as ASATable. At last click on Authorize and click on Save.</p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/13.PNG"/>

<h2>Adding Query</h2>
<p>1.  Now, let us go to Query at the left side menu and add a piece of query finding fraudulent phone calls. Copy the below given query and paste it in the querying pane and click on Save. </p>
    <p>SELECT System.Timestamp AS WindowEnd, COUNT(*) AS FraudulentCalls </p>
	<p>INTO "MyPBIoutput" </p>
	<p>FROM "CallStream" CS1 TIMESTAMP BY CallRecTime </p>
	<p>JOIN "CallStream" CS2 TIMESTAMP BY CallRecTime </p>
	<p>ON CS1.CallingIMSI = CS2.CallingIMSI </p>
	<p>AND DATEDIFF(ss, CS1, CS2) BETWEEN 1 AND 5 </p>
	<p>WHERE CS1.SwitchNum != CS2.SwitchNum </p>
	<p>GROUP BY TumblingWindow(Duration(second, 1)) </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/14.PNG"/>
<p>2. After saving the query, click on the dots as shown below and choose Sample data from input.</p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/15.PNG"/>
<p>3. Let the Duration be 3 minutes and click on ok.  </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/16.PNG"/>
<p>4.Now click on Test. This will query for Fraud calls that get registered by the application. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/17.PNG"/>
<p>5. At last, go to Overview page of the job and click on Start button to begin the execution of job to detect fraud calls that are given as messages by EventHub. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/18.PNG"/>

<h2>Visualizing in Power BI</h2>
<p>1. Navigate to the site of Power BI from the link - https://powerbi.com/ and login there using the same Power BI credentials that you used in stream analytics job. In the homepage of BI, click on + Create and choose Dashboard. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/19.PNG"/>
<p>2. Name it as Fraudulent Calls and click on create. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/20.PNG"/>
<p>3. Now, click on + Add tile and go to Custom Streaming Data and click on Next. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/21.PNG"/>
<p>4. Next, in the place of dataset, ASAdataset and click on Next. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/22.PNG"/>
<p>5. Now, for the visualization type choose Card and in Fields choose fraudulentcalls and click on Next. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/23.PNG"/>
<p>6. At last, name the tile and click on apply. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/24.PNG"/>
<p>7. Once again click on + Add tile and choose Custom Streaming Data and click Next.  </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/25.PNG"/>
<p>8. Choose the ASAdataset and hit Next. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/26.PNG"/>
<p>9. In the next window for Axis choose windowend. Same way for Values choose fraudulentcalls. Then choose 10 minutes for time window display and click Next. </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/27.PNG"/>
<p>10. At last give it a name and click on Apply</p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/28.PNG"/>
<p>11. Now, you will be displayed with a windowed graph for the fraudulent calls that are generated by the application. Here, you will get the graph only when the data is sent by mobile client application to EventHub and analysed in stream analytics.  </p>
<img src="https://codesizzlergit.blob.core.windows.net/ms-demo-3/29.PNG"/>
